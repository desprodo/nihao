<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹çˆ±å†›å¸ˆ - AI åŠ©ä½ è¯»æ‡‚ TA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans SC', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #fff0f3 0%, #ffe4e9 50%, #ffdde5 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .heart-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .heart {
            position: absolute;
            color: rgba(255, 182, 193, 0.2);
            animation: float 15s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-30px) rotate(10deg); opacity: 0.6; }
        }

        .upload-zone {
            background: linear-gradient(135deg, rgba(255, 240, 245, 0.9), rgba(255, 228, 235, 0.9));
            border: 2px dashed #ff9eb5;
            transition: all 0.3s ease;
        }

        .upload-zone:hover, .upload-zone.dragover {
            background: linear-gradient(135deg, rgba(255, 235, 240, 0.95), rgba(255, 220, 230, 0.95));
            border-color: #ff6b8a;
            transform: scale(1.02);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b8a 0%, #ff8fa3 50%, #ffb3c1 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 138, 0.4);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 138, 0.5);
        }

        .btn-primary:disabled {
            background: linear-gradient(135deg, #ccc 0%, #ddd 100%);
            cursor: not-allowed;
        }

        .thumbnail-item {
            transition: all 0.3s ease;
        }

        .thumbnail-item:hover {
            transform: scale(1.05);
        }

        .thumbnail-item .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .thumbnail-item:hover .delete-btn {
            opacity: 1;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.9);
            border-left: 4px solid #ff6b8a;
            animation: slideIn 0.5s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            border: 3px solid rgba(255, 107, 138, 0.2);
            border-top-color: #ff6b8a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .typing-text::after {
            content: '|';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .tag {
            background: linear-gradient(135deg, #ffe4e9, #ffdde5);
            color: #d63384;
        }

        .star-filled {
            color: #ffb700;
        }

        .star-empty {
            color: #ddd;
        }
    </style>
</head>
<body class="relative">
    <!-- èƒŒæ™¯çˆ±å¿ƒè£…é¥° -->
    <div class="heart-bg">
        <div class="heart" style="top: 10%; left: 5%; font-size: 24px;">ğŸ’•</div>
        <div class="heart" style="top: 20%; right: 10%; font-size: 32px; animation-delay: 2s;">ğŸ’–</div>
        <div class="heart" style="top: 60%; left: 8%; font-size: 20px; animation-delay: 4s;">ğŸ’—</div>
        <div class="heart" style="top: 70%; right: 5%; font-size: 28px; animation-delay: 1s;">ğŸ’</div>
        <div class="heart" style="top: 40%; left: 15%; font-size: 16px; animation-delay: 3s;">ğŸ’“</div>
        <div class="heart" style="top: 80%; left: 50%; font-size: 22px; animation-delay: 5s;">ğŸ’˜</div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-lg">
        <!-- å¤´éƒ¨ -->
        <header class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-rose-500 mb-4 shadow-lg">
                <span class="text-3xl">ğŸ’</span>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">æ‹çˆ±å†›å¸ˆ</h1>
            <p class="text-pink-600 font-medium">AI åŠ©ä½ è¯»æ‡‚ TA çš„å¿ƒ</p>
        </header>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div id="uploadSection" class="glass-card rounded-2xl p-6 mb-6">
            <div
                id="uploadZone"
                class="upload-zone rounded-xl p-8 text-center cursor-pointer"
                onclick="document.getElementById('fileInput').click()"
            >
                <input
                    type="file"
                    id="fileInput"
                    multiple
                    accept="image/*"
                    class="hidden"
                    onchange="handleFileSelect(event)"
                >
                <div class="text-5xl mb-3">ğŸ“¸</div>
                <p class="text-gray-700 font-medium mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æˆªå›¾</p>
                <p class="text-sm text-gray-500">è‡³å°‘ä¸Šä¼  5 å¼ æœ‹å‹åœˆæˆªå›¾</p>
                <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
            </div>

            <!-- ç¼©ç•¥å›¾é¢„è§ˆ -->
            <div id="previewArea" class="hidden mt-4">
                <p class="text-sm text-gray-600 mb-3">
                    å·²ä¸Šä¼  <span id="imageCount" class="font-bold text-pink-600">0</span> å¼ 
                    <span id="countHint" class="text-xs text-gray-400 ml-2">(è¿˜éœ€ <span id"needCount">5</span> å¼ )</span>
                </p>
                <div id="thumbnailGrid" class="grid grid-cols-4 gap-2">
                    <!-- åŠ¨æ€ç”Ÿæˆç¼©ç•¥å›¾ -->
                </div>
            </div>

            <!-- å¼€å§‹åˆ†ææŒ‰é’® -->
            <button
                id="analyzeBtn"
                onclick="startAnalysis()"
                disabled
                class="btn-primary w-full mt-6 py-4 rounded-xl text-white font-bold text-lg flex items-center justify-center gap-2"
            >
                <span id="btnText">å¼€å§‹åˆ†æ</span>
                <span id="btnIcon">ğŸ’•</span>
            </button>
        </div>

        <!-- åˆ†æä¸­çŠ¶æ€ -->
        <div id="loadingSection" class="hidden glass-card rounded-2xl p-8 text-center">
            <div class="loading-spinner w-16 h-16 mx-auto mb-6"></div>
            <p id="loadingText" class="text-lg text-gray-700 font-medium typing-text">AI æ­£åœ¨åˆ†æä¸­...</p>
            <p class="text-sm text-gray-500 mt-2">é¢„è®¡éœ€è¦ 30-60 ç§’</p>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div id="resultSection" class="hidden">
            <!-- TA çš„ç”»åƒ -->
            <div class="result-card rounded-xl p-5 mb-4" style="animation-delay: 0.1s;">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ’¡</span>
                    <h3 class="text-lg font-bold text-gray-800">TA çš„ç”»åƒ</h3>
                </div>
                <div id="profileContent">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>

            <!-- è¿½æ±‚ç­–ç•¥ -->
            <div class="result-card rounded-xl p-5 mb-4" style="animation-delay: 0.3s;">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">ğŸ¯</span>
                    <h3 class="text-lg font-bold text-gray-800">è¿½æ±‚ç­–ç•¥</h3>
                </div>
                <div id="strategyContent">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>

            <!-- æˆåŠŸæ¦‚ç‡ -->
            <div class="result-card rounded-xl p-5 mb-6" style="animation-delay: 0.5s;">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">âš¡</span>
                    <h3 class="text-lg font-bold text-gray-800">æˆåŠŸæ¦‚ç‡</h3>
                </div>
                <div id="successRateContent">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>

            <!-- é‡æ–°åˆ†ææŒ‰é’® -->
            <button
                onclick="resetAnalysis()"
                class="w-full py-4 rounded-xl border-2 border-pink-400 text-pink-600 font-bold text-lg hover:bg-pink-50 transition-colors"
            >
                é‡æ–°åˆ†æ ğŸ’«
            </button>
        </div>

        <!-- åº•éƒ¨éšç§å£°æ˜ -->
        <footer class="text-center mt-8 text-xs text-gray-400">
            <p>ğŸ”’ å›¾ç‰‡ä»…ç”¨äº AI åˆ†æï¼Œåˆ†æåå³åˆ»åˆ é™¤</p>
            <p class="mt-1">æ‹çˆ±å†›å¸ˆ Â· è®©è¿½æ±‚æ›´æœ‰æŠŠæ¡</p>
        </footer>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        let uploadedFiles = [];
        let isAnalyzing = false;

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            handleFiles(files);
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            if (files.length === 0) return;

            uploadedFiles = [...uploadedFiles, ...files].slice(0, 20); // æœ€å¤š20å¼ 
            updatePreview();
            updateButtonState();
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const previewArea = document.getElementById('previewArea');
            const thumbnailGrid = document.getElementById('thumbnailGrid');
            const imageCount = document.getElementById('imageCount');
            const countHint = document.getElementById('countHint');

            if (uploadedFiles.length > 0) {
                previewArea.classList.remove('hidden');
                imageCount.textContent = uploadedFiles.length;

                const needCount = Math.max(0, 5 - uploadedFiles.length);
                countHint.innerHTML = needCount > 0
                    ? `(è¿˜éœ€ <span class="text-pink-600 font-bold">${needCount}</span> å¼ )`
                    : '<span class="text-green-500">âœ“ å¯ä»¥å¼€å§‹åˆ†æäº†</span>';

                thumbnailGrid.innerHTML = uploadedFiles.map((file, index) => `
                    <div class="thumbnail-item relative aspect-square rounded-lg overflow-hidden border-2 border-pink-200">
                        <img src="${URL.createObjectURL(file)}" class="w-full h-full object-cover" alt="é¢„è§ˆ">
                        <button
                            onclick="deleteImage(${index})"
                            class="delete-btn absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"
                        >Ã—</button>
                    </div>
                `).join('');
            } else {
                previewArea.classList.add('hidden');
            }
        }

        // åˆ é™¤å›¾ç‰‡
        function deleteImage(index) {
            uploadedFiles.splice(index, 1);
            updatePreview();
            updateButtonState();
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState() {
            const btn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');

            if (uploadedFiles.length >= 5) {
                btn.disabled = false;
                btnText.textContent = 'å¼€å§‹åˆ†æ';
            } else {
                btn.disabled = true;
                btnText.textContent = `è¿˜éœ€ ${5 - uploadedFiles.length} å¼ `;
            }
        }

        // Loading æ–‡æ¡ˆè½®æ’­
        const loadingTexts = [
            'AI æ­£åœ¨åˆ†ææ€§æ ¼ç‰¹ç‚¹...',
            'æ­£åœ¨è§£è¯» TA çš„å…´è¶£çˆ±å¥½...',
            'æ­£åœ¨ç”Ÿæˆè¿½æ±‚ç­–ç•¥...',
            'å†›å¸ˆæ­£åœ¨æ€è€ƒä¸­...'
        ];

        function rotateLoadingText() {
            const loadingText = document.getElementById('loadingText');
            let index = 0;
            return setInterval(() => {
                index = (index + 1) % loadingTexts.length;
                loadingText.textContent = loadingTexts[index];
            }, 2000);
        }

        // å¼€å§‹åˆ†æ
        async function startAnalysis() {
            if (uploadedFiles.length < 5 || isAnalyzing) return;

            isAnalyzing = true;

            // åˆ‡æ¢ç•Œé¢
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('loadingSection').classList.remove('hidden');

            // å¼€å§‹è½®æ’­æ–‡æ¡ˆ
            const textInterval = rotateLoadingText();

            try {
                // è¯»å–æ‰€æœ‰å›¾ç‰‡ä¸º base64
                const imagePromises = uploadedFiles.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            // æå– base64 æ•°æ®ï¼ˆå»æ‰ data:image/xxx;base64, å‰ç¼€ï¼‰
                            const base64 = e.target.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.readAsDataURL(file);
                    });
                });

                const imageBase64List = await Promise.all(imagePromises);

                // è°ƒç”¨åç«¯ API
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        images: imageBase64List
                    })
                });

                const result = await response.json();

                // æ£€æŸ¥æ˜¯å¦å‡ºé”™
                if (!response.ok || result.code !== 0) {
                    throw new Error(result.message || 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }

                // æ˜¾ç¤ºç»“æœ
                clearInterval(textInterval);
                displayResult(result.data);

            } catch (error) {
                clearInterval(textInterval);
                alert('åˆ†æå‡ºé”™ï¼š' + error.message);
                resetAnalysis();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(data) {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');

            // ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´ï¼Œæä¾›é»˜è®¤å€¼
            const profile = data.profile || {};
            const strategy = data.strategy || {};
            const successRate = data.successRate || {};

            // æ¸²æŸ“ TA çš„ç”»åƒ
            const tags = profile.tags || ['ç¥ç§˜', 'æœ‰è¶£', 'ç‹¬ç‰¹'];
            const emotionStatus = profile.emotionStatus || 'ä¿¡æ¯ä¸è¶³ï¼Œå»ºè®®å¤šè§‚å¯Ÿ';

            const profileHtml = `
                <div class="flex flex-wrap gap-2 mb-3">
                    ${tags.map(tag => `
                        <span class="tag px-3 py-1 rounded-full text-sm font-medium">${tag}</span>
                    `).join('')}
                </div>
                <p class="text-gray-600 text-sm">ğŸ’­ æƒ…æ„ŸçŠ¶æ€ï¼š<span class="text-gray-800 font-medium">${emotionStatus}</span></p>
            `;
            document.getElementById('profileContent').innerHTML = profileHtml;

            // æ¸²æŸ“è¿½æ±‚ç­–ç•¥
            const iceBreaker = strategy.iceBreaker || 'ä»æœ‹å‹åœˆäº’åŠ¨å¼€å§‹ï¼Œç‚¹ä¸ªèµæˆ–ç•™ä¸‹çœŸè¯šè¯„è®º';
            const topics = strategy.topics || ['ç¾é£Ÿ', 'æ—…è¡Œ', 'ç”µå½±'];
            const warning = strategy.warning || 'ä¸è¦æ“ä¹‹è¿‡æ€¥ï¼Œå…ˆåšæœ‹å‹';

            const strategyHtml = `
                <div class="space-y-3 text-sm">
                    <div class="bg-pink-50 rounded-lg p-3">
                        <span class="font-medium text-pink-700">ğŸ§Š ç ´å†°å»ºè®®ï¼š</span>
                        <p class="text-gray-700 mt-1">${iceBreaker}</p>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">ğŸ’¬ æ¨èè¯é¢˜ï¼š</span>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${topics.map(topic => `
                                <span class="bg-white border border-pink-200 px-3 py-1 rounded-lg text-gray-700">${topic}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-amber-50 rounded-lg p-3">
                        <span class="font-medium text-amber-700">âš ï¸ é¿é›·æé†’ï¼š</span>
                        <p class="text-gray-700 mt-1">${warning}</p>
                    </div>
                </div>
            `;
            document.getElementById('strategyContent').innerHTML = strategyHtml;

            // æ¸²æŸ“æˆåŠŸæ¦‚ç‡
            const difficulty = Math.min(5, Math.max(1, successRate.difficulty || 3));
            const keyAdvice = successRate.keyAdvice || 'ä¿æŒçœŸè¯šï¼Œå±•ç°ä½ çš„ä¼˜ç‚¹';

            const stars = Array(5).fill(0).map((_, i) =>
                i < difficulty ? 'â˜…' : 'â˜†'
            ).join('');

            const difficultyText = ['ææ˜“', 'å®¹æ˜“', 'ä¸­ç­‰', 'å›°éš¾', 'æéš¾'][difficulty - 1] || 'ä¸­ç­‰';

            const successRateHtml = `
                <div class="text-center">
                    <div class="text-3xl mb-2">
                        ${stars.split('').map(s =>
                            s === 'â˜…' ? '<span class="star-filled">â˜…</span>' : '<span class="star-empty">â˜…</span>'
                        ).join('')}
                    </div>
                    <p class="text-sm text-gray-500 mb-3">è¿½æ±‚éš¾åº¦ï¼š${difficultyText}</p>
                    <div class="bg-gradient-to-r from-pink-100 to-rose-100 rounded-lg p-4">
                        <span class="font-medium text-pink-700">ğŸ’¡ æ ¸å¿ƒå»ºè®®ï¼š</span>
                        <p class="text-gray-800 mt-1 font-medium">${keyAdvice}</p>
                    </div>
                </div>
            `;
            document.getElementById('successRateContent').innerHTML = successRateHtml;

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // é‡æ–°åˆ†æ
        function resetAnalysis() {
            uploadedFiles = [];
            isAnalyzing = false;

            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('previewArea').classList.add('hidden');
            document.getElementById('fileInput').value = '';

            updateButtonState();

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
